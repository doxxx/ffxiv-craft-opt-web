<div>

  <div class="row-fluid ">
    <div class="recipe-search-control">
      <form class="form-inline">
        <div class="dropdown">
          <div class="input-append">
            <span class="input-small uneditable-input">{{recipe.cls}}</span>

            <div class="btn-group">
              <button class="btn dropdown-toggle"><span class="caret"></span></button>
              <ul class="dropdown-menu pull-right">
                <li ng-repeat="cls in allClasses"><a ng-click="recipe.cls=cls">{{cls}}</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="my-dropdown" id="recipe-menu-root" >
          <div class="input-append">
            <span class="span4 uneditable-input my-dropdown-toggle">{{recipe.name}}</span>

            <div class="btn-group">
              <button class="btn my-dropdown-toggle"><span class="caret"></span></button>
            </div>
          </div>
          <div class="my-dropdown-menu">
            <input class="input-medium search my-dropdown-focus" type="text" name="name"
                   ng-model="recipeSearch.text"
                   placeholder="Search..." select-on-focus stop-click-propogation
                   ng-keypress="onSearchKeyPress($event)" ng-keydown="onSearchKeyDown($event)"
                   id="recipe-search-text"/>
            <ul class="recipe-menu-scrollable" isolate-scrolling>
              <li class="loading" ng-show="recipeSearch.loading"><i class="fa fa-spinner fa-spin"></i> Loading...
              </li>
              <li ng-hide="recipeSearch.loading"
                  ng-repeat="r in recipeSearch.list | orderBy:recipeSearch.order"
                  ng-class="{active: $index === recipeSearch.selected}"
                  id="recipeSearchElement{{$index}}"
                  ng-mouseover="recipeSearch.selected=$index"
                  ng-click="recipeSelected(r.name)">
                <a ng-click="recipeSelected(r.name)">[{{r.baseLevel}}{{'*'.repeat(r.stars)}}] {{r.name}}</a>
              </li>
            </ul>
          </div>
        </div>
      </form>
    </div>
    <div class="row-fluid">
      <div class="span8">
        <simulator-status class="initial-guess" crafter="crafter.stats[recipe.cls]" bonus-stats="bonusStats" recipe="recipe" status="simulatorStatus"
                          valid="isValidSequence(simulatorStatus.sequence, recipe.cls)"></simulator-status>
      </div>
      <div class="span4">
        <div class="bonus-stats">
          <div class="well well-small">
            <h5>L{{crafter.stats[recipe.cls].level}} {{recipe.cls}} Attributes <a ui-sref="crafter-attributes"><i class="fa fa-edit"></i></a></h5>
            <form name="bonusStatsForm">
              <table>
                <tr>
                  <td>Craftsmanship</td>
                  <td class="value">{{crafter.stats[recipe.cls].craftsmanship}}</td>
                  <td>+</td>
                  <td>
                    <input class="input-mini" type="number" min="0" required force-numeric ng-model="bonusStats.craftsmanship"/>
                  </td>
                </tr>
                <tr>
                  <td>Control</td>
                  <td class="value">{{crafter.stats[recipe.cls].control}}</td>
                  <td>+</td>
                  <td>
                    <input class="input-mini" type="number" min="0" required force-numeric ng-model="bonusStats.control"/>
                  </td>
                </tr>
                <tr>
                  <td>CP</td>
                  <td class="value">{{crafter.stats[recipe.cls].cp}}</td>
                  <td>+</td>
                  <td>
                    <input class="input-mini" type="number" min="0" required force-numeric ng-model="bonusStats.cp"/>
                  </td>
                </tr>
                <tr>
                  <td>Start Quality</td>
                  <td class="value"></td>
                  <td>+</td>
                  <td>
                    <input class="input-mini" type="number" min="0" required force-numeric ng-model="bonusStats.startQuality"/>
                  </td>
                </tr>
              </table>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row-fluid">
    <div class="span12">
      <div class="row-fluid">
        <div ng-class="{'edit-mode': editingSequence}" ng-show="editingSequence">
          <buffs effects="simulatorStatus.state.effects" recipe="recipe"></buffs>
          <div class="sequence-editor" ng-controller="SequenceEditorCtrl">
            <div class="sequence well well-small">
              <div ng-repeat="action in editSequence track by $index"
                    class="image-wrap glossy icon selectable"
                    ng-class="actionClasses(action, recipe.cls, $index)"
                    ng-click="removeAction($index)"
                    lvl-draggable="true"
                    lvl-drop-target="true"
                    data-index="{{$index}}"
                    on-drop="dropAction(dragEl, dropEl)">
                <img ng-src="{{getActionImagePath(action, recipe.cls)}}"/>
                <span ng-if="actionForName(action).cpCost" class="cp">{{actionForName(action).cpCost}}</span>
                <span ng-if="isActionCrossClass(action, cls)" class="cross-class">
                  <img ng-src="img/classes/{{actionForName(action).cls}}.png"/>
                </span>
              </div>

              <img class="action empty-action" lvl-drop-target="true"
                   src="img/actions/empty.png"
                   data-index="{{editSequence.length}}"
                   on-drop="dropAction(dragEl, dropEl)"/>
            </div>
            <div class="control-group">
              <button class="btn" ng-click="cancel()">Cancel</button>
              <button class="btn btn-primary" ng-disabled="!isSequenceDirty()" ng-click="save()">Save</button>
              <button class="btn btn-warning" ng-disabled="!isSequenceDirty()" ng-click="revert()">Revert</button>
              <button class="btn btn-warning" ng-disabled="editSequence.length == 0" ng-click="clear()">Clear</button>
            </div>
            <h5>Available Actions <small>(<a ui-sref="crafter-attributes">edit</a>)</small></h5>

            <div class="action-table">
              <action-table cls="recipe.cls" action-classes="actionTableClasses" selectable="true" draggable="true"
                            on-click="addAction" tooltip-placement="right"/>
            </div>
          </div>
        </div>
        <div ng-show="!editingSequence">
          <action-sequence actions="sequence" cls="recipe.cls" tooltip-placement="right"
                           action-classes="seqeunceActionClasses"></action-sequence>

          <div class="btn-toolbar pull-left">
            <div class="input-prepend input-append" dropdown>
              <div class="btn-group">
                <button class="btn" dropdown-toggle><span class="caret"></span></button>
                <ul class="dropdown-menu left">
                  <li ng-repeat="name in savedSynthNames | orderBy:'toString()'">
                    <a ng-click="loadSynth(name)">{{name}}</a>
                  </li>
                </ul>
              </div>
                <span class="uneditable-input span4">
                  <span ng-class="{'invisible': !isSynthDirty()}"><i class="fa fa-asterisk"></i></span>
                  {{synthNameForDisplay()}}
                </span>

              <div class="btn-group">
                <!--
                  -- Hack for bug in angular-ui-bootstrap (fixed in 0.13)
                  -- ng-disabled elements don't close their tooltip
                  -->
                <button class="btn" ng-click="revertSynth()" ng-class="{'disabled': !isSynthDirty()}" tooltip="Revert"><i class="fa fa-undo"></i></button>
                <button class="btn" ng-click="saveSynth()" ng-class="{'disabled': !isSynthDirty()}" tooltip="Save"><i class="fa fa-floppy-o"></i></button>
                <button class="btn" ng-click="saveSynthAs()" tooltip="Save As"><i class="fa fa-plus"></i></button>
                <button class="btn" ng-click="renameSynth()" tooltip="Rename"><i class="fa fa-pencil"></i></button>
                <button class="btn" ng-click="deleteSynth()" tooltip="Delete"><i class="fa fa-trash"></i></button>
              </div>
            </div>
          </div>

          <div class="btn-toolbar pull-right">
            <button class="btn btn-primary" ng-click="editSequenceInline()" ng-disabled="simulatorStatus.running">
              Edit...
            </button>
            <button class="btn btn-primary" ng-click="goToSolver()">Solve...</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row-fluid">
    <tabset>
      <tab active="logTabs.monteCarlo.active">
        <tab-heading>Monte Carlo Sim &nbsp; <i class="fa fa-refresh flat-button"
                                               ng-click="$emit('simulation.needs.update')"></i></tab-heading>
        <pre>{{simulatorStatus.monteCarlo.logText}}</pre>
      </tab>
      <tab active="logTabs.probabilistic.active">
        <tab-heading>Probabilistic Sim</tab-heading>
        <pre>{{simulatorStatus.probabilistic.logText}}</pre>
      </tab>
      <tab active="logTabs.macro.active">
        <tab-heading>Macro</tab-heading>
        <macros sequence="sequence" options="macroOptions"></macros>
      </tab>
    </tabset>
  </div>
</div>
